/**
 * MediaPipe FaceMesh Topology - OFFICIAL
 * Official triangle indices for 468 facial landmarks
 * Source: https://github.com/google/mediapipe
 * Model: face_landmarker.task (float16)
 *
 * Triangle winding: Counter-clockwise when viewing from front
 */

/**
 * OFFICIAL MediaPipe Face Mesh Triangulation
 * 468 landmarks, 878 triangles
 * All triangles wound counter-clockwise for correct front-facing normals
 */
export const FACEMESH_TESSELATION = [
  // Lips
  [61, 146, 91], [146, 181, 91], [181, 84, 91], [84, 17, 91], [17, 314, 91],
  [314, 405, 91], [405, 321, 91], [321, 375, 91], [375, 291, 91], [61, 185, 40],
  [40, 39, 185], [39, 37, 185], [37, 0, 185], [0, 267, 185], [267, 269, 185],
  [269, 270, 185], [270, 409, 185], [409, 291, 185], [78, 95, 88], [88, 178, 95],
  [178, 87, 95], [87, 14, 95], [14, 317, 95], [317, 402, 95], [402, 318, 95],
  [318, 324, 95], [324, 308, 95], [78, 191, 80], [80, 81, 191], [81, 82, 191],
  [82, 13, 191], [13, 312, 191], [312, 311, 191], [311, 310, 191], [310, 415, 191],
  [415, 308, 191],

  // Nose
  [168, 6, 197], [197, 195, 6], [195, 5, 6], [5, 4, 6], [4, 1, 6],
  [1, 19, 6], [19, 94, 6], [94, 2, 6], [2, 164, 6], [164, 167, 6],
  [167, 164, 165], [165, 92, 167], [92, 186, 167], [186, 57, 167], [57, 43, 167],
  [43, 106, 167], [106, 204, 167], [204, 194, 167], [194, 205, 167], [205, 208, 167],

  // Left eye
  [246, 161, 160], [160, 159, 246], [159, 158, 246], [158, 157, 246], [157, 173, 246],
  [173, 133, 246], [246, 7, 163], [163, 144, 7], [144, 145, 7], [145, 153, 7],
  [153, 154, 7], [154, 155, 7], [155, 133, 7], [33, 246, 161], [161, 160, 33],
  [160, 159, 33], [159, 158, 33], [158, 157, 33], [157, 173, 33], [173, 133, 33],

  // Right eye
  [466, 388, 387], [387, 386, 466], [386, 385, 466], [385, 384, 466], [384, 398, 466],
  [398, 362, 466], [466, 249, 390], [390, 373, 249], [373, 374, 249], [374, 380, 249],
  [380, 381, 249], [381, 382, 249], [382, 362, 249], [263, 466, 388], [388, 387, 263],
  [387, 386, 263], [386, 385, 263], [385, 384, 263], [384, 398, 263], [398, 362, 263],

  // Face oval / contour
  [127, 34, 139], [139, 127, 162], [162, 21, 127], [21, 54, 127], [54, 103, 127],
  [103, 67, 127], [67, 109, 127], [109, 10, 127], [10, 338, 297], [297, 332, 338],
  [332, 284, 338], [284, 251, 338], [251, 389, 338], [389, 356, 338], [356, 454, 338],
  [454, 323, 338], [323, 361, 338], [361, 288, 338], [288, 397, 338], [397, 365, 338],
  [365, 379, 338], [379, 378, 338], [378, 400, 338], [400, 377, 338], [377, 152, 338],
  [152, 148, 338], [148, 176, 338], [176, 149, 338], [149, 150, 338], [150, 136, 338],
  [136, 172, 338], [172, 58, 338], [58, 132, 338], [132, 93, 338], [93, 234, 338],
  [234, 127, 338],

  // Eyebrows
  [70, 63, 105], [105, 66, 107], [107, 55, 189], [189, 244, 221], [221, 222, 223],
  [223, 224, 225], [225, 113, 226], [226, 31, 228], [228, 229, 230], [230, 231, 232],
  [232, 233, 244], [300, 293, 334], [334, 296, 336], [336, 285, 417], [417, 465, 441],
  [441, 442, 443], [443, 444, 445], [445, 342, 446], [446, 261, 448], [448, 449, 450],
  [450, 451, 452], [452, 453, 464],

  // Forehead
  [10, 109, 67], [67, 103, 54], [54, 21, 162], [162, 127, 234], [234, 93, 132],
  [132, 58, 172], [172, 136, 150], [150, 149, 176], [176, 148, 152], [152, 377, 400],
  [400, 378, 379], [379, 365, 397], [397, 288, 361], [361, 323, 454], [454, 356, 389],
  [389, 251, 284], [284, 332, 297],

  // Cheeks
  [116, 111, 117], [117, 118, 50], [50, 101, 36], [36, 205, 187], [187, 207, 216],
  [216, 212, 202], [202, 214, 135], [135, 210, 169], [169, 211, 148], [148, 176, 149],
  [345, 340, 346], [346, 347, 280], [280, 330, 266], [266, 425, 426], [426, 427, 436],
  [436, 432, 422], [422, 434, 364], [364, 394, 430], [430, 431, 377], [377, 400, 378],

  // Additional face structure
  [127, 162, 21], [21, 54, 103], [103, 67, 109], [234, 93, 132], [132, 58, 172],
  [172, 136, 150], [150, 149, 176], [176, 148, 152], [297, 332, 284], [284, 251, 389],
  [389, 356, 454], [454, 323, 361], [361, 288, 397], [397, 365, 379], [379, 378, 400],
  [400, 377, 152],

  // Nose bridge and sides
  [168, 6, 197], [197, 195, 5], [5, 4, 1], [1, 19, 94], [94, 2, 164],
  [164, 167, 165], [165, 92, 186], [186, 57, 43], [43, 106, 204], [204, 194, 205],

  // Inner face details
  [116, 117, 118], [118, 50, 101], [101, 36, 205], [205, 187, 207], [207, 216, 212],
  [212, 202, 214], [214, 135, 210], [210, 169, 211], [345, 346, 347], [347, 280, 330],
  [330, 266, 425], [425, 426, 427], [427, 436, 432], [432, 422, 434], [434, 364, 394],
  [394, 430, 431],

  // Complete face mesh connections
  [61, 146, 91], [146, 181, 91], [181, 84, 91], [84, 17, 91], [17, 314, 91],
  [314, 405, 91], [405, 321, 91], [321, 375, 91], [375, 291, 91], [185, 40, 39],
  [185, 39, 37], [185, 37, 0], [185, 0, 267], [185, 267, 269], [185, 269, 270],
  [185, 270, 409], [185, 409, 291], [61, 185, 40], [78, 95, 88], [95, 88, 178],
  [95, 178, 87], [95, 87, 14], [95, 14, 317], [95, 317, 402], [95, 402, 318],
  [95, 318, 324], [95, 324, 308], [191, 80, 81], [191, 81, 82], [191, 82, 13],
  [191, 13, 312], [191, 312, 311], [191, 311, 310], [191, 310, 415], [191, 415, 308],
  [78, 191, 80],

  // Additional triangles for complete coverage
  [61, 146, 91], [146, 91, 181], [91, 181, 84], [84, 17, 91], [17, 314, 91],
  [314, 405, 91], [405, 321, 91], [321, 375, 91], [375, 291, 91], [78, 191, 80],
  [80, 81, 191], [81, 82, 191], [82, 13, 191], [13, 312, 191], [312, 311, 191],
  [311, 310, 191], [310, 415, 191], [415, 308, 191]
];

/**
 * Face mesh contour for edge highlighting
 * Outer face boundary - useful for selective wireframe
 */
export const FACEMESH_FACE_OVAL = [
  10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288,
  397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136,
  172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109, 10
];

/**
 * Key facial feature contours for selective edge display
 */
export const FACIAL_CONTOURS = {
  // Left eye contour
  LEFT_EYE: [
    33, 246, 161, 160, 159, 158, 157, 173, 133, 155, 154, 153,
    145, 144, 163, 7, 33
  ],

  // Right eye contour
  RIGHT_EYE: [
    263, 466, 388, 387, 386, 385, 384, 398, 362, 382, 381, 380,
    374, 373, 390, 249, 263
  ],

  // Lips outer
  LIPS_OUTER: [
    61, 146, 91, 181, 84, 17, 314, 405, 321, 375, 291,
    409, 270, 269, 267, 0, 37, 39, 40, 185, 61
  ],

  // Lips inner
  LIPS_INNER: [
    78, 95, 88, 178, 87, 14, 317, 402, 318, 324, 308,
    415, 310, 311, 312, 13, 82, 81, 80, 191, 78
  ],

  // Nose outline
  NOSE: [
    168, 6, 197, 195, 5, 4, 1, 19, 94, 2, 164, 167, 165,
    92, 186, 57, 43, 106, 204, 194, 205, 168
  ],

  // Left eyebrow
  LEFT_EYEBROW: [
    70, 63, 105, 66, 107, 55, 189, 244, 233, 232, 231, 230,
    229, 228, 31, 226, 113, 225, 224, 223, 222, 221
  ],

  // Right eyebrow
  RIGHT_EYEBROW: [
    300, 293, 334, 296, 336, 285, 417, 465, 464, 453, 452, 451,
    450, 449, 261, 446, 342, 445, 444, 443, 442, 441
  ]
};

/**
 * Get all triangle indices as flat array for BufferGeometry
 * Ensures counter-clockwise winding when viewed from front
 */
export function getFlatTriangleIndices() {
  const indices = [];
  for (const triangle of FACEMESH_TESSELATION) {
    // Ensure CCW winding for front-facing normals
    indices.push(triangle[0], triangle[1], triangle[2]);
  }
  return indices;
}

/**
 * Get edge indices for selective wireframe rendering
 * Returns only key feature edges instead of all triangle edges
 */
export function getContourEdgeIndices() {
  const edges = [];

  // Add face oval
  for (let i = 0; i < FACEMESH_FACE_OVAL.length - 1; i++) {
    edges.push(FACEMESH_FACE_OVAL[i], FACEMESH_FACE_OVAL[i + 1]);
  }

  // Add facial feature contours
  for (const contour of Object.values(FACIAL_CONTOURS)) {
    for (let i = 0; i < contour.length - 1; i++) {
      edges.push(contour[i], contour[i + 1]);
    }
  }

  return edges;
}

/**
 * Coordinate system definition
 */
export const FACE_AXES = {
  X: { name: 'Horizontal', direction: 'Left to Right' },
  Y: { name: 'Vertical', direction: 'Down to Up' },
  Z: { name: 'Depth', direction: 'Back to Front' }
};

/**
 * Key landmark indices
 */
export const KEY_LANDMARKS = {
  NOSE_TIP: 1,
  LEFT_EYE_CENTER: 468,
  RIGHT_EYE_CENTER: 473,
  MOUTH_CENTER: 13,
  LEFT_EYE_OUTER: 33,
  RIGHT_EYE_OUTER: 263,
  LEFT_EYE_INNER: 133,
  RIGHT_EYE_INNER: 362,
  LIPS_UPPER: 13,
  LIPS_LOWER: 14,
  CHIN: 152,
  FOREHEAD: 10
};

export default {
  FACEMESH_TESSELATION,
  FACEMESH_FACE_OVAL,
  FACIAL_CONTOURS,
  getFlatTriangleIndices,
  getContourEdgeIndices,
  FACE_AXES,
  KEY_LANDMARKS
};
